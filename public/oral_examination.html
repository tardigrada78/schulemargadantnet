<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>M√ºndliche Pr√ºfung</title>
    <link rel="stylesheet" href="style_black.css" />
</head>

<body>
    <a href="/index.html" target="_blank">Weitere KI-Tools (Startseite)</a>&nbsp;&nbsp;&nbsp;
    <a href="/feedback.html" target="_blank">Feedback geben</a>
    <h1>Virtuelle m√ºndliche Pr√ºfung</h1>
    <h3>Pr√ºfungsstoff</h3>
    <textarea id="contentForms" name="contentForms" cols="70" rows="6">
Erkl√§ren Sie die Hauptfunktionen der folgenden Zellorganellen: Zellkern, Mitochondrium, Chloroplast, Ribosom.</textarea>
    <button id="questionStart">üßë‚Äçüè´ Pr√ºfung starten</button>
    <div id="invisible" style="display: none">
        <h3>Pr√ºfungsfrage</h3>
        <div id="examQuestion"></div>
    </div>
    <h3>Ich</h3>
    <textarea id="chatUser" name="chatUser" cols="70" rows="2"></textarea><br>
    <audio id="recordedAudio" controls style="display: none; margin: 10px 0;"></audio><br>
    <button id="recordButton">üé§ Sprechen</button>
    <button id="chatStart">‚úâÔ∏è Textnachricht senden</button><br><br>
    <div id="progressDiv"></div>
    <h3>Pr√ºfungsleitung</h3>
    <div id="audioDiv"></div>
    <div id="roundedDiv"></div>
    <br><br>
    <label for="voiceSelect">Stimme der KI. Die Stimmen k√∂nnen <a href="https://www.openai.fm/">hier</a> probegeh√∂rt
        werden.</label>
    <select id="voiceSelect" name="voiceSelect">
        <option value="alloy">Alloy (f)</option>
        <option value="ash">Ash (m)</option>
        <option value="ballad">Ballad</option>
        <option value="coral">Coral (f)</option>
        <option value="echo">Echo (m)</option>
        <option value="fable">Fable (m)</option>
        <option value="nova" selected>Nova (f)</option>
        <option value="onyx">Onyx (m)</option>
        <option value="sage">Sage (f)</option>
        <option value="shimmer">Shimmer (f)</option>
        <option value="verse">Verse (m)</option>
    </select>
    <label for="profileSelect">Charakter der Pr√ºfungsleitung.</label>
    <select id="profileSelect" name="profileSelect">
        <option value="nett" selected>Nette, wohlwollende Atmosph√§re</option>
        <option value="unangenehm">Unangenehme Situation</option>
    </select>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let voice
        let chatAI
        let voiceProfile
        let profileText
        let questionAI

        // Sprachaufnahme-Funktionalit√§t  
        document.getElementById("recordButton").addEventListener("click", async function () {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = function (event) {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = async function () {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioURL = URL.createObjectURL(audioBlob);
                        const recordedAudio = document.getElementById("recordedAudio");
                        recordedAudio.src = audioURL;
                        recordedAudio.style.display = 'block';
                        document.getElementById("progressDiv").textContent = "Sende Original-Audio...";
                        processVoiceInput(audioBlob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById("recordButton").textContent = "‚èπÔ∏è Aufnahme stoppen und Pr√ºfung abgeben";
                    document.getElementById("progressDiv").textContent = "üî¥ Sprechen Sie klar und deutlich...";
                    setTimeout(() => {
                        if (isRecording) {
                            document.getElementById("progressDiv").textContent = "üî¥ Aufnahme l√§uft...";
                        }
                    }, 1000);
                } catch (error) {
                    console.error("Mikrofon-Fehler:", error);
                    document.getElementById("progressDiv").textContent = "‚ùå Mikrofon-Zugriff verweigert";
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById("recordButton").textContent = "üé§ Sprechen";
                document.getElementById("progressDiv").textContent = "Verarbeite Audio...";
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });

        // Sprachaufnahme verarbeiten
        async function processVoiceInput(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm'); // WebM statt WAV!
                const response = await fetch('/oralexamination/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.transcript) {
                    document.getElementById("chatUser").value = data.transcript;
                    document.getElementById("chatStart").click();
                    document.getElementById("progressDiv").textContent = "";
                } else {
                    throw new Error(data.error || 'Spracherkennung fehlgeschlagen');
                }
            } catch (error) {
                console.error("Sprachverarbeitung-Fehler:", error);
                document.getElementById("progressDiv").textContent = "‚ùå Spracherkennung fehlgeschlagen. Ist richtige Mikrofon aktiviert?";
            }
        }

        // Funktion f√ºr Frage-Generierung serverseitig
        async function generateQuestion(questionContent) {
            let response = await fetch("/oralexamination/getQuestion", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ questionContent }),
            });
            let data = await response.json();
            return data.chatAnswer;
        }

        // Funktion f√ºr Chat-Antwort serverseitig
        async function generateChat(chatContent, questionAI, profileText) {
            let response = await fetch("/oralexamination/getChat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ chatContent, questionAI, profileText }),
            });
            let data = await response.json();
            return data.chatAnswer;
        }

        // Funktion f√ºr Audio-Antwort serverseitig
        async function generateAudio(content, voice, voiceProfile) {
            let response = await fetch("/oralexamination/getAudio", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ content, voice, voiceProfile }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Fehler beim Generieren der Sprachdatei: ${errorText}`);
            }
            let data = await response.json();
            return data.audio;
        }


        // Frage generieren
        document.getElementById("questionStart").addEventListener("click", async function () {
            try {
                document.getElementById("examQuestion").innerHTML = "";
                document.getElementById("roundedDiv").innerHTML = "";
                // document.getElementById("chatUser").innerHTML = "";
                voice = document.getElementById("voiceSelect").value;
                let profile = document.getElementById("profileSelect").value;
                if (profile == "nett") {
                    voiceProfile = "Sprich mit einer warmen, beruhigenden Stimme. Strahle Zuversicht und Wohlwollen aus. Du m√∂chtest einen nerv√∂sen Pr√ºfungskandidaten beruhigen.";
                    profileText = "Du bist nett, wohlwollend und motivierend. Du m√∂chtest, dass sich der Pr√ºfungskandidat geborgen f√ºhlt."
                } else {
                    voiceProfile = "Sprich mit einer kalten, harten Stimme. Du m√∂chtest, dass sich der Pr√ºfungskandidat unwohl und unsicher f√ºhlt.";
                    profileText = "Du bist arrogant, gestresst und uninteressiert. Du m√∂chtest, dass sich der Pr√ºfungskandidat unwohl und unsicher f√ºhlt."

                }
                const questionContent = document.getElementById("contentForms").value;
                document.getElementById("progressDiv").innerHTML = "<p>‚öôÔ∏è Pr√ºfungsfrage wird erstellt...</p>";
                questionAI = await generateQuestion(questionContent);
                questionAI = questionAI + "<br><br>Beantworten Sie die Frage m√ºndlich oder per Textchat."
                document.getElementById("invisible").style.display = "block";
                document.getElementById("progressDiv").innerHTML = ``;
            } catch (error) {
                console.error("Fehler beim Erstellen der Frage:", error);
                document.getElementById("progressDiv").innerHTML = `<p>‚ùå Fehler beim Erstellen der Frage.</p>`;
            }
            // Sprache generieren
            console.log(voice, voiceProfile)
            generateAudio(questionAI, voice, voiceProfile)
                .then((speechURL) => {
                    document.getElementById("audioDiv").innerHTML = `<audio id="audioPlayer" controls src="${speechURL}"></audio>`;
                    let audio = document.getElementById("audioPlayer");
                    audio.play();
                    document.getElementById("examQuestion").innerHTML = questionAI
                    document.getElementById("progressDiv").innerHTML = "";
                })
                .catch((error) => {
                    console.error("Fehler beim Generieren der Sprachdatei:", error);
                    document.getElementById("progressDiv").innerHTML = "‚ùå Fehler beim Generieren der Sprachdatei.";
                });

        });
        // Antwort generieren
        document.getElementById("chatStart").addEventListener("click", async function () {
            try {
                const chatContent = document.getElementById("chatUser").value;
                document.getElementById("progressDiv").innerHTML = "<p>‚öôÔ∏è R√ºckmeldung auf die Pr√ºfungsantwort...</p>";
                chatAI = await generateChat(chatContent, questionAI, profileText);
                document.getElementById("progressDiv").innerHTML = `<p>‚öôÔ∏è Sprachdatei wird erstellt...</p>`;
            } catch (error) {
                console.error("Fehler:", error);
                document.getElementById("progressDiv").innerHTML = `<p>‚ùå Fehler</p>`;
            }
            // Sprache generieren
            generateAudio(chatAI, voice, voiceProfile)
                .then((speechURL) => {
                    document.getElementById("audioDiv").innerHTML = `<audio id="audioPlayer" controls src="${speechURL}"></audio>`;
                    let audio = document.getElementById("audioPlayer");
                    audio.play();
                    document.getElementById("roundedDiv").innerHTML = chatAI
                    document.getElementById("progressDiv").innerHTML = "";
                })
                .catch((error) => {
                    console.error("Fehler beim Generieren der Sprachdatei:", error);
                    document.getElementById("progressDiv").innerHTML = "‚ùå Fehler beim Generieren der Sprachdatei.";
                });

        });
    </script>
</body>

</html>