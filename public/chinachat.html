<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chinesisch plaudern</title>
    <link rel="stylesheet" href="style_black.css" />
</head>

<body>
    <a href="/index.html" target="_blank">Weitere KI-Tools (Startseite)</a>&nbsp;&nbsp;&nbsp;
    <a href="/feedback.html" target="_blank">Feedback geben</a>
    <h1>Chinesisch plaudern</h1>
    <h3>Ich</h3>
    <textarea id="chatUser" name="chatUser" cols="70" rows="2">‰Ω†Âè´‰ªÄ‰πàÂêçÂ≠ó?</textarea><br>
    <audio id="recordedAudio" controls style="display: none; margin: 10px 0;"></audio><br>
    <button id="recordButton">üé§ Sprechen</button>
    <button id="chatStart">‚úâÔ∏è Textnachricht senden</button><br><br>
    <h3>KI</h3>
    <div id="roundedDiv">Sprechen oder schreiben Sie etwas, damit die KI antworten kann.</div>
    <div id="audioDiv"></div><br><br>
    <label for="voice">Stimme der KI. Die Stimmen k√∂nnen <a href="https://www.openai.fm/">hier</a> probegeh√∂rt
        werden.</label>
    <select id="voice" name="voice">
        <option value="alloy">Alloy (f)</option>
        <option value="ash">Ash (m)</option>
        <option value="ballad">Ballad</option>
        <option value="coral">Coral (f)</option>
        <option value="echo">Echo (m)</option>
        <option value="fable">Fable (m)</option>
        <option value="nova" selected>Nova (f)</option>
        <option value="onyx">Onyx (m)</option>
        <option value="sage">Sage (f)</option>
        <option value="shimmer">Shimmer (f)</option>
        <option value="verse">Verse (m)</option>
    </select>
    <div id="progressDiv"></div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Sprachaufnahme-Funktionalit√§t  
        document.getElementById("recordButton").addEventListener("click", async function () {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = function (event) {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = async function () {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioURL = URL.createObjectURL(audioBlob);
                        const recordedAudio = document.getElementById("recordedAudio");
                        recordedAudio.src = audioURL;
                        recordedAudio.style.display = 'block';
                        document.getElementById("progressDiv").textContent = "Sende Original-Audio...";
                        processVoiceInput(audioBlob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById("recordButton").textContent = "‚èπÔ∏è Stoppen";
                    document.getElementById("progressDiv").textContent = "üî¥ Sprechen Sie klar und deutlich...";

                    // Warnung bei zu kurzer Aufnahme
                    setTimeout(() => {
                        if (isRecording) {
                            document.getElementById("progressDiv").textContent = "üî¥ Weiter sprechen f√ºr bessere Erkennung...";
                        }
                    }, 1000);
                } catch (error) {
                    console.error("Mikrofon-Fehler:", error);
                    document.getElementById("progressDiv").textContent = "‚ùå Mikrofon-Zugriff verweigert";
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById("recordButton").textContent = "üé§ Sprechen";
                document.getElementById("progressDiv").textContent = "Verarbeite Audio...";
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        });

        // Sprachaufnahme verarbeiten
        async function processVoiceInput(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm'); // WebM statt WAV!
                document.getElementById("progressDiv").textContent = "üéØ Erkenne Sprache...";
                const response = await fetch('/chinachat/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok && data.transcript) {
                    document.getElementById("chatUser").value = data.transcript;

                    // Sofort Chat starten f√ºr fl√ºssiges Gespr√§ch
                    setTimeout(() => {
                        document.getElementById("chatStart").click();
                        setTimeout(() => document.getElementById("progressDiv").textContent = "", 5000);
                    }, 500); // Etwas l√§nger warten damit User Audio checken kann
                } else {
                    throw new Error(data.error || 'Spracherkennung fehlgeschlagen');
                }
            } catch (error) {
                console.error("Sprachverarbeitung-Fehler:", error);
                document.getElementById("progressDiv").textContent = "‚ùå Spracherkennung fehlgeschlagen";
            }
        }

        // Funktion f√ºr Chat-Antwort serverseitig
        async function generateChat(chatContent) {
            let response = await fetch("/chinachat/getChat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ chatContent }),
            });
            let data = await response.json();
            return data.chatAnswer;
        }

        // Funktion f√ºr Audio-Antwort serverseitig
        async function generateAudio(content, voice, voiceProfile) {
            let response = await fetch("/chinachat/getAudio", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ content, voice, voiceProfile }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Fehler beim Generieren der Sprachdatei: ${errorText}`);
            }
            let data = await response.json();
            return data.audio;
        }

        // Hauptprogramm
        document.getElementById("chatStart").addEventListener("click", async function () {
            try {
                const chatContent = document.getElementById("chatUser").value;
                document.getElementById("progressDiv").innerHTML = "<p>‚öôÔ∏è Antworte auf die Chat-Nachricht...</p>";
                chatAI = await generateChat(chatContent);
                document.getElementById("roundedDiv").innerHTML = chatAI
                document.getElementById("progressDiv").innerHTML = `<p>‚öôÔ∏è Sprachdatei wird erstellt...</p>`;
            } catch (error) {
                console.error("Fehler:", error);
                document.getElementById("progressDiv").innerHTML = `<p>‚ùå Fehler</p>`;
            }
            let voice = document.getElementById("voice").value;
            let voiceProfile = "Sprich mit einer warmen, fr√∂hlichen Stimme. Sprich langsam, klar und sehr deutlich. Du sprichst mit einem Anf√§nger der chinesischen Sprache.";
            generateAudio(chatAI, voice, voiceProfile)
                .then((speechURL) => {
                    document.getElementById("audioDiv").innerHTML = `<audio id="audioPlayer" controls src="${speechURL}"></audio>`;
                    let audio = document.getElementById("audioPlayer");
                    audio.play();
                    document.getElementById("progressDiv").innerHTML = "";
                })
                .catch((error) => {
                    console.error("Fehler beim Generieren der Sprachdatei:", error);
                    document.getElementById("progressDiv").innerHTML = "‚ùå Fehler beim Generieren der Sprachdatei.";
                });
        });
    </script>
</body>

</html>