<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KI-Geschichten-Generator</title>
    <link rel="stylesheet" href="style_black.css" />
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.19.2/dist/index.js"></script>
</head>

<body>
    <a href="/index.html" target="_blank">Weitere KI-Tools (Startseite)</a>&nbsp;&nbsp;&nbsp;
    <a href="/feedback.html" target="_blank">Feedback geben</a>
    <h1>KI-Geschichten-Generator</h1>
    <button id="generateStory">Erfinde eine Geschichte !</button>
    <p>Bewegen Sie den Mauszeiger über ein Wort, um die Übersetzung zu sehen.</p>
    <div id="storyOutput"></div>
    <br /><br />
    <div id="imageOutput">
        <img id="generatedImage" alt="" style="max-width: 100%; height: auto" />
    </div>
    <div id="speechOutput"></div>
    <br>
    <div id="wordListOutput"></div>

    <script>
        async function generateTitle(storyText) {
            let response = await fetch("/chinastory/title", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ story: storyText }),
            });
            let data = await response.json();
            return data.title;
        }
        async function generatePicture(storyText) {
            const response = await fetch("/chinastory/picture", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ story: storyText }),
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || "Fehler beim Laden des Bildes");
            }
            return `data:image/png;base64,${data.image}`;
        }

        async function generateSpeech(storyText) {
            let response = await fetch("/chinastory/speech", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ story: storyText }),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Fehler beim Generieren der Sprachdatei: ${errorText}`);
            }
            let data = await response.json();
            return data.speech;
        }

        // Wait for the DOM and all scripts to load
        window.addEventListener('load', function () {
            document.getElementById("generateStory").addEventListener("click", async () => {
                try {
                    document.getElementById("storyOutput").innerHTML =
                        "<p>⚙️ Die Geschichte wird geschrieben, bitte warten ...</p>";
                    let response = await fetch("/chinastory/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });
                    let data = await response.json();
                    // console.log(data.story)

                    // Split the story for hover effect
                    let story = data.story.replace(/\n/g, " ");
                    story = story.replace(/\) *\)/g, ")");
                    story = story.replace(/  +/g, " ");
                    story = story.replace(/\)/g, "(");
                    story = story.replace(/\( /g, "(");
                    let storyArray = story.split("(");
                    let storyText = "";
                    let storyTitle = "";
                    let imageURL = "";

                    // Create HTML with hover text
                    let storyHtml = "";
                    let wordList = [];
                    let wordListHTML = "<h3>Wortliste</h3><table>";
                    for (let i = 0; i < storyArray.length - 1; i += 2) {
                        let pinyinText = pinyinPro.pinyin(storyArray[i], { toneType: 'symbol' });
                        storyHtml += `<div class="hover"><span>${storyArray[i]
                            }</span><span class="hover-text"><span class="hover-pinyin">${pinyinText}</span><br>${storyArray[i + 1]
                            }</span></div>\n`;
                        storyText += ` ${storyArray[i]}`;
                        if (!wordList.some(entry => entry[2] === storyArray[i + 1])) {
                            wordList.push([storyArray[i], pinyinText, storyArray[i + 1]]);
                        }
                    }
                    wordList.sort((x, y) => x[2].localeCompare(y[2]));
                    wordList.forEach((word) => {
                        wordListHTML += `<tr><td>${word[0]}</td><td>${word[1]}</td><td>${word[2]}</td></tr>`
                    });
                    wordListHTML += "</table>"

                    // Generate title and update website
                    generateTitle(storyText).then((title) => {
                        storyTitle = title;
                        storyHtml = `<h2>${storyTitle}</h2>${storyHtml}`;
                        document.getElementById("storyOutput").innerHTML = storyHtml;
                        document.getElementById("wordListOutput").innerHTML = wordListHTML;
                    });

                    // Generate voice output
                    generateSpeech(storyText)
                        .then((speechURL) => {
                            document.getElementById(
                                "speechOutput"
                            ).innerHTML = `<audio id="audioPlayer" controls src="${speechURL}"></audio>`;
                            let audio = document.getElementById("audioPlayer");
                        })
                        .catch((error) => {
                            console.error("Fehler beim Generieren der Sprachdatei:", error);
                            alert("Es gab ein Problem beim Generieren der Sprachdatei.");
                        });

                    // Generate picture and update website
                    generatePicture(storyText)
                        .then((image) => {
                            imageURL = image;
                            document.getElementById("generatedImage").src = imageURL;
                        })
                        .catch((error) => {
                            console.error("Fehler beim Generieren des Bildes:", error);
                            alert("Es gab ein Problem beim Generieren des Bildes.");
                        });


                } catch (error) {
                    console.error("Error fetching story:", error);
                    document.getElementById("storyOutput").innerHTML = "Fehler beim Erstellen der Geschichte";
                }
            });
        });
    </script>
</body>

</html>